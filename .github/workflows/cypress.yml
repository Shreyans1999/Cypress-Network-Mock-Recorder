name: Cypress Tests with Network Mocking

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Test mode (record/replay)'
        required: true
        default: 'replay'
        type: choice
        options:
          - record
          - replay

env:
  NODE_VERSION: '20'

jobs:
  # Run tests in replay mode (default for CI)
  test-replay:
    name: üü¢ Replay Mode Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.mode != 'record'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests (Replay Mode)
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
        env:
          MODE: replay
          CYPRESS_MODE: replay

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-replay
          path: cypress/screenshots
          if-no-files-found: ignore

  # Run tests in record mode (manual trigger or explicit request)
  test-record:
    name: üî¥ Record Mode Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'record'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests (Record Mode)
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
        env:
          MODE: record
          CYPRESS_MODE: record

      - name: Upload recorded mocks
        uses: actions/upload-artifact@v4
        with:
          name: recorded-mocks
          path: cypress/mocks
          if-no-files-found: warn

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-record
          path: cypress/screenshots
          if-no-files-found: ignore

  # Commit recorded mocks back to repo (optional)
  commit-mocks:
    name: üìù Commit Recorded Mocks
    runs-on: ubuntu-latest
    needs: test-record
    if: github.event.inputs.mode == 'record' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download recorded mocks
        uses: actions/download-artifact@v4
        with:
          name: recorded-mocks
          path: cypress/mocks

      - name: Commit and push mocks
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cypress/mocks/
          git diff --staged --quiet || git commit -m "chore: update recorded API mocks [skip ci]"
          git push
